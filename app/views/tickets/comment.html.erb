<% @page_title = 'Ticket #' + @ticket.id.to_s %>

<div id="content">
  <%= render_next_prev_links -%>

  <div class="breadcrumbs">
    <ul>
      <li><%= link_to 'Tickets', :action => 'index' -%></li>
      <li>&#187; Ticket #<%= @ticket.id -%></li>
    </ul>
  </div>

  <%= error_messages_for @ticket %>
  <%= error_messages_for @change %>

  <div id="ticket">
    <h1>Ticket #<%= @ticket.id -%> (<%= @ticket.status.name -%>)<span class="date"><%= @ticket.created_at -%></span></h1>
    <h2><%=h @ticket.summary -%></h2>

    <table id="ticket-details">
      <tr>
        <td class="info">Reported by:</td>
        <td><%= tickethelp_format_author @ticket.author -%></td>
        <td class="info">Severity:</td>
        <td><%= @ticket.severity.name -%></td>
      </tr>
      <tr>
        <td class="info">Part:</td>
        <td><%= @ticket.part.name unless @ticket.part.nil? -%></td>
        <td class="info">Release:</td>
        <td><%= @ticket.release.name unless @ticket.release.nil? -%></td>
      </tr>
      <tr>
        <td class="info">Milestone:</td>
        <td><%= @ticket.milestone.name unless @ticket.milestone.nil? -%></td>
        <td class="info">Status</td>
        <td><%= @ticket.status.name-%></td>
      </tr>
    </table>

  <h3>Details by <%= tickethelp_format_author @ticket.author -%>:</h3>
  <%= htmlize(@ticket.content) %>
  </div>

  <% if @ticket.ticket_change_ids.compact.any? %>
    <h3>Changelog:</h3>
    <div id="ticket-changes">
      <% @ticket.ticket_changes.each do |change| %>
        <% next if change.new_record? %>

        <h4>Modified by <%= tickethelp_format_author change.author -%> <%= change.created_at.strftime('%a, %B %d %Y - %H:%M:%S %Z') -%></h4>
        <ul>
          <% change.each_log do |log_entry| -%>
            <li><%= tickethelp_format_changes log_entry %></li>
          <% end -%>
          <% if change.has_attachment? -%>
            <li><strong>Attachment</strong> added: <%= link_to(change.attachment, :action => "attachment", :id => change.id) %></li>
          <% end -%>
        </ul>

        <% if change.comment.present? -%>
          <div id="ticket-change-comment"><%= htmlize(change.comment) %></div>
        <% end -%>
      <% end %>
    </div>
  <% end %>

  <h3 id="comment">Update ticket:</h3>

  <%= form_with(model: @ticket, url: url_for(action: 'comment', id: @ticket.id), method: :post, html: { multipart: true }) do |f| %>
    <fieldset>
      <legend>Add comment and/or change ticket properties</legend>

      <%= f.fields_for(:ticket_changes, @change) do |fc| %>
        <%= fc.label :attachment, 'Attachment:', class: 'first' %>
        <%= fc.file_field :attachment %>

        <%= fc.label :comment, 'Comment:' %>
        <%= fc.text_area :comment, rows: 12 -%>
      <% end %>

      <br />
      <%= f.label :summary, 'Ticket summary:' %>
      <%= f.text_field :summary %>

      <table>
        <tr class="set-status">
          <td><%= f.label :status_id, 'Status:' %></td>
          <td><%= f.collection_select :status_id, @status, 'id', 'name' %></td>
        </tr>
        <tr>
          <td><%= f.label :severity_id, 'Severity:' %></td>
          <td><%= f.collection_select :severity_id, @severities, 'id', 'name' %></td>
        </tr>
        <tr>
          <td><%= f.label :part_id, 'Part:' %></td>
          <td><%= f.collection_select :part_id, @parts, 'id', 'name', { include_blank: true } %></td>
        </tr>
        <tr>
          <td><%= f.label :release_id, 'Release:' %></td>
          <td><%= f.collection_select :release_id, @releases, 'id', 'name', { include_blank: true } %></td>
        </tr>
        <tr>
          <td><%= f.label :milestone_id, 'Milestone:' %></td>
          <td><%= f.collection_select :milestone_id, @milestones, 'id', 'name', { include_blank: true } %></td>
        </tr>
      </table>
    </fieldset>

    <%= f.submit 'Submit changes' %>
  <% end %>
  <%= render_next_prev_links -%>
</div>
